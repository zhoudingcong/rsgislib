#! /usr/bin/env python

############################################################################
# Copyright (c) 2012 Dr. Peter Bunting
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.
#
#
# Purpose:  A class to generate XML for the RSGISLib library based
#           on a supplied template.
# Author: Pete Bunting
# Email: petebunting@mac.com
# Date: 19/03/2012
# Version: 1.0
#
# History:
# Version 1.0 - Created.
# Version 1.1 - Changed to names rather than symbols in template
#
#############################################################################

import os.path
import sys
from time import strftime
import optparse

class RSGISLibXMLSingle (object):

    def readInputTemplate(self, inputFile):
        xmloutline = str()
        inputXMLFile = open(inputFile, 'r')
        for eachLine in inputXMLFile:
            xmloutline = xmloutline + eachLine
        return xmloutline

    def constructXMLFile(self, files, xmloutline, outputfile, path, baseNames):
        outputXMLFile = open(outputfile, 'w')
        outputXMLFile.write('<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n')
        outputXMLFile.write('<!--\n')
        outputXMLFile.write('    Description\n')
        outputXMLFile.write('        XML File for execution within @RSGISLIB_PACKAGE_STRING@\n')
        outputXMLFile.write('    Created by rsgislibcmdxml.py on ')
        timeStr = strftime('%a %b %m %H:%M:%S %Y.')
        outputXMLFile.write(timeStr)
        outputXMLFile.write('\n')
        outputXMLFile.write('    Copyright (c) @RSGISLIB_COPYRIGHT_YEAR@ [Your Organisation]. All rights reserved.\n')
        outputXMLFile.write('-->\n')
        outputXMLFile.write('<rsgis:commands xmlns:rsgis=\"http://www.rsgislib.org/xml/\">\n')
        print("Replacing: $PATH with ", path)
        xmloutlinereplacepath = xmloutline.replace('$PATH', path, xmloutline.count('$PATH'))

        xmloutlinereplacebase = xmloutlinereplacepath
        count = 1
        for baseName in baseNames:
            baseName = baseName.strip()
            symbolReplace = str("$FILENAME") + str(count)
            print("Replacing: ", symbolReplace, " with ", baseName)
            xmloutlinereplacebase = xmloutlinereplacebase.replace(symbolReplace, baseName, xmloutlinereplacebase.count(symbolReplace))
            count = count + 1

        xmloutlinereplaceFiles = xmloutlinereplacebase
        count = 1
        for file in files:
            file = file.strip()
            symbolReplace = str("$FILEPATH") + str(count)
            print("Replacing: ", symbolReplace, " with ", file)
            xmloutlinereplaceFiles = xmloutlinereplaceFiles.replace(symbolReplace, file, xmloutlinereplaceFiles.count(symbolReplace))
            count = count + 1

        outputXMLFile.write(xmloutlinereplaceFiles)
        outputXMLFile.write('\n')
        outputXMLFile.write('</rsgis:commands>\n')
        outputXMLFile.flush()
        outputXMLFile.close()

    def run(self, cmdargs):
        print('rsgislibcmdxml.py script generates the XML commands for the ')
        print('@PACKAGE@ software library from a user defined template.')
        print('This script was distributed with @RSGISLIB_PACKAGE_STRING@')
        print('Copyright (C) @RSGISLIB_COPYRIGHT_YEAR@ Peter Bunting and Daniel Clewley')
        print('For support please email @RSGISLIB_PACKAGE_BUGREPORT@')

        inTemplateStr = self.readInputTemplate(cmdargs.inputxml)
        self.constructXMLFile(cmdargs.files, inTemplateStr, cmdargs.outputxml.strip(), cmdargs.outFilePath.strip(), cmdargs.baseNames)
        print('Commands written to single XML file')
        print('Run using:\n rsgisexe -x ' + cmdargs.outputxml.strip())


# Command arguments
class CmdArgs:
  def __init__(self):
    p = optparse.OptionParser()
    p.add_option("-i","--input", dest="inputxml", default=None, help="Input XML template")
    p.add_option("-o","--output", dest="outputxml", default=None, help="Output XML file")
    p.add_option("-b","--base", action="append", dest="baseNames", default=None, help="Output file base file names (\'$FILENAME1\', \'$FILENAME2\'...\'$FILENAMEn\')")
    p.add_option("-p","--path", dest="outFilePath", default=None, help="Output file path (\'$PATH\')")
    p.add_option("-f","--file", action="append", dest="files", default=None, help="Input files to be replaced using $FILEPATHx for files in order (e.g., $FILEPATH1, $FILEPATH2 ... $FILEPATHn).")

    (options, args) = p.parse_args()
    self.__dict__.update(options.__dict__)

    if self.inputxml is None:
        p.print_help()
        print("Input xml file must be set.")
        sys.exit()

    if self.outputxml is None:
        p.print_help()
        print("Output xml filename must be set.")
        sys.exit()

if __name__ == '__main__':
    cmdargs = CmdArgs()
    obj = RSGISLibXMLSingle()
    obj.run(cmdargs)

