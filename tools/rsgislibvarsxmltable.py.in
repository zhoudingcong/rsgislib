#! /usr/bin/env python

############################################################################
# Copyright (c) 2012 Dr. Peter Bunting
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
# THE SOFTWARE.
#
#
# Purpose:  A class to generate XML for the RSGISLib library based
#           on a supplied template. Variables within the template are
#           replaced by ones from a text file.
# Author: Pete Bunting
# Email: petebunting@mac.com
# Date: 02/04/2012
# Version: 1.0
#
# History:
# Version 1.0 - Created.
# Versoin 2.0 - Modified to read variables from a table and replace using column
#               and row indices.
#               Dan Clewley (daniel.clewley@gmail.com) 24/05/2012
#
#############################################################################

import os.path
import sys
from time import strftime
import optparse
import numpy as np

class RSGISLibXMLVariablesTable (object):

    def readInputTemplate(self, inputFile):
        xmloutline = str()
        inputXMLFile = open(inputFile, 'r')
        for eachLine in inputXMLFile:
            xmloutline = xmloutline + eachLine
        return xmloutline

    def constructXMLFile(self, variables, headerrows, xmloutline, outputfile):
        outputXMLFile = open(outputfile, 'w')
        
        xmloutlineWithVarValues = xmloutline
        
        print("Reading Variables from: " + variables)

        # Read input file into array
        inVarTable = np.genfromtxt(variables ,delimiter=',',skiprows=headerrows)
        
        j = inVarTable.shape[0] - 1
        
        while j >= 0:
            i = inVarTable.shape[1] - 1
            while i >= 0:
                inVar = str(inVarTable[j,i])
                symbolReplace = str("$VAR") + str(i) + "_" + str(j)
                print("Replacing: ", symbolReplace, " with ", inVar)
                xmloutlineWithVarValues = xmloutlineWithVarValues.replace(symbolReplace, inVar, xmloutlineWithVarValues.count(symbolReplace))
                i = i - 1
            j = j - 1
        
        outputXMLFile.write(xmloutlineWithVarValues)

        outputXMLFile.flush()
        outputXMLFile.close()

    def run(self, cmdargs):
        print('rsgislibcmdxml.py script generates the XML commands for the ')
        print('@PACKAGE@ software library from a user defined template.')
        print('This script was distributed with @RSGISLIB_PACKAGE_STRING@')
        print('Copyright (C) @RSGISLIB_COPYRIGHT_YEAR@ Peter Bunting and Daniel Clewley')
        print('For support please email @RSGISLIB_PACKAGE_BUGREPORT@')

        inTemplateStr = self.readInputTemplate(cmdargs.inputxml)
        print(cmdargs.headerrows)
        self.constructXMLFile(cmdargs.variables[0], int(cmdargs.headerrows[0]), inTemplateStr, cmdargs.outputxml.strip())
        print('Commands written to single XML file')
        print('If complete run using:\n rsgisexe -x ' + cmdargs.outputxml.strip())
        

# Command arguments
class CmdArgs:
  def __init__(self):
    p = optparse.OptionParser()
    p.add_option("-i","--input", dest="inputxml", default=None, help="Input XML template")
    p.add_option("-o","--output", dest="outputxml", default=None, help="Output XML file")
    p.add_option("-t","--table", action="append", dest="variables", default=None, help="Table containing input variables to replace $VARcol_row where col and row are the colum and row indexes in the input table (e.g., $VAR0_0, $VAR1_1 ... $VARn_m).")
    p.add_option("-r","--headerrows", action="append", dest="headerrows", default=None, help="Number of header rows to skip in input table")

    (options, args) = p.parse_args()
    self.__dict__.update(options.__dict__)

    if self.inputxml is None:
        p.print_help()
        print("Input xml file must be set.")
        sys.exit()

    if self.outputxml is None:
        p.print_help()
        print("Output xml filename must be set.")
        sys.exit()

if __name__ == '__main__':
    cmdargs = CmdArgs()
    obj = RSGISLibXMLVariablesTable()
    obj.run(cmdargs)

